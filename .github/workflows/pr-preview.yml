name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ main ]

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy-preview:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 9
    
    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'pnpm'
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile --ignore-scripts
    
    - name: Build
      run: pnpm build
      env:
        CI: false
        # Set base path for PR preview (custom domain doesn't need /leaderboard prefix)
        VITE_BASE_PATH: /pr-${{ github.event.pull_request.number }}/
    
    - name: Verify build output
      run: |
        echo "Build output contents:"
        ls -R dist/
        echo "Checking for index.html:"
        test -f dist/index.html && echo "âœ“ index.html exists" || echo "âœ— index.html missing"
        echo "Checking for assets:"
        test -d dist/assets && echo "âœ“ assets directory exists" || echo "âœ— assets directory missing"
    
    - name: Deploy to GitHub Pages (PR Preview)
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
        folder: dist
        target-folder: pr-${{ github.event.pull_request.number }}
        clean: false
        single-commit: false
    
    - name: Comment PR with preview link
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const previewUrl = `https://leaderboard.sliitfoss.org/pr-${prNumber}/`;
          
          const comment = `## ðŸš€ Preview Deployment
          
          Your PR has been deployed for preview!
          
          **Preview URL:** ${previewUrl}
          
          This preview will be updated automatically when you push new commits to this PR.
          
          ---
          *Preview build powered by GitHub Pages*`;
          
          // Check if we already commented
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const existingComment = comments.find(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('Preview Deployment')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
          }

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: gh-pages
    
    - name: Remove preview directory
      run: |
        git config user.name github-actions[bot]
        git config user.email github-actions[bot]@users.noreply.github.com
        rm -rf pr-${{ github.event.pull_request.number }}
        git add .
        git commit -m "Remove preview for PR #${{ github.event.pull_request.number }}" || echo "No changes to commit"
        git push origin gh-pages || echo "Nothing to push"
    
    - name: Comment PR about cleanup
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
            body: '## ðŸ§¹ Preview Cleanup\n\nThe preview deployment has been removed as this PR is now closed.'
          });

